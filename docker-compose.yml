services:
  # 1. Your Java Application Service (Test Runner)
  app:
    # Uses the current directory for the Dockerfile (where your Java project is built)
    build: .
    # CRITICAL FIX: The app service waits until the database reports that it is 'healthy'.
    depends_on:
      db:
        condition: service_healthy
    # If your Dockerfile sets the CMD, leave this commented.
    # Otherwise, uncomment and set your main entry point (e.g., tests or main class).
    # entrypoint: ["java", "-jar", "/tmp/app.jar"]

  # 2. The MySQL Database Service
  db:
    # Context to build the MySQL image (where your world.sql is located)
    build:
      context: ./db
    # Always restart the database if it crashes
    restart: always
    environment:
      # These variables populate the database and must match App.java
      MYSQL_ROOT_PASSWORD: example
      MYSQL_DATABASE: world
    # Mapping the port is useful for connecting from IntelliJ (Host:3306 -> Container:3306)
    ports:
      - "3306:3306"

    # CRITICAL ADDITION: Health check tells Docker exactly when the database is ready.
    healthcheck:
      # Command runs inside the container to ping the MySQL server with credentials.
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-pexample"]
      # Check every 10 seconds
      interval: 10s
      # Wait up to 10 seconds for a response
      timeout: 10s
      # Allow up to 5 failures before declaring 'unhealthy'
      retries: 5