services:
  # 1. Your Java Application Service (Test Runner)
  app:
    # Build context points to the root directory where your Dockerfile is located.
    build: .
    # CRITICAL FIX: Ensure the app waits until the database passes its health check.
    depends_on:
      db:
        condition: service_healthy
    # If running directly from IntelliJ, you may use a specific command:
    # entrypoint: ["java", "-jar", "/tmp/app.jar"]

  # 2. The MySQL Database Service
  db:
    # Assuming your Dockerfile/context for MySQL is in a folder named 'db'
    build:
      context: ./db
    # Always restart the database if it crashes unexpectedly
    restart: always
    environment:
      # These must match the settings in your App.java connect() method
      MYSQL_ROOT_PASSWORD: example
      MYSQL_DATABASE: world
    # Map the internal container port (3306) to the host machine port (3306).
    ports:
      - "3306:3306"

    # CRITICAL ADDITION: Health check to ensure MySQL is fully ready (not just running)
    healthcheck:
      # Command runs inside the container to verify the server is responding to a ping
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-pexample"]
      interval: 5s
      timeout: 10s
      retries: 5